<!DOCTYPE html>
<html lang="en" class="govuk-template">
  <head>
    <meta charset="utf-8">
    <title>Edit site and surroundings - Review - BOPS Experiments</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0b0c0c">

    <link rel="icon" sizes="48x48" href="/assets/images/favicon.ico">
    <link rel="icon" sizes="any" href="/assets/images/favicon.svg" type="image/svg+xml">
    <link rel="mask-icon" href="/assets/images/govuk-icon-mask.svg" color="#0b0c0c">
    <link rel="apple-touch-icon" href="/assets/images/govuk-icon-180.png">

    <!-- GOV.UK Frontend -->
    <link rel="stylesheet" href="/stylesheets/govuk-frontend.min.css">

    <!-- Component CSS -->
    <link rel="stylesheet" href="/components/css/layout.css">
    <link rel="stylesheet" href="/components/css/header.css">
    <link rel="stylesheet" href="/components/css/case-summary.css">
    <link rel="stylesheet" href="/components/css/sidebar.css">
    <link rel="stylesheet" href="/components/css/main-content.css">

    <style>
      /* Edit page specific styles */
      .app-button-group {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
      }
      .app-button-group .govuk-button {
        margin-bottom: 0;
      }

      /* Active/current item in sidebar */
      .task-list__item--active {
        background-color: #ffffff;
        margin-left: -20px;
        margin-right: -20px;
        padding-left: 16px;
        padding-right: 20px;
        border-left: 4px solid #1d70b8;
      }
      .task-list__item--active .task-list__name {
        font-weight: 700;
      }
    </style>
  </head>
  <body class="govuk-template__body">
    <script>document.body.className += ' js-enabled' + ('noModule' in HTMLScriptElement.prototype ? ' govuk-frontend-supported' : '');</script>

    <a href="#main-content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

    <!-- Sticky Header -->
    <div class="sticky-header">
      <header class="govuk-header" data-module="govuk-header">
        <div class="govuk-header__container">
          <div class="govuk-header__logo">
            <a href="/" class="govuk-header__link govuk-header__link--homepage">
              <strong>Southwark</strong> Back-office Planning System
            </a>
          </div>
          <div class="govuk-header__content">
            <span class="govuk-header__link">Pat Botsford</span>
            <a href="#" class="govuk-header__link">Log out</a>
          </div>
        </div>
      </header>

      <!-- Case Summary -->
      <div class="case-summary">
        <span class="govuk-body govuk-!-font-weight-bold case-summary__reference">23-00527-PRE</span>
        <div class="case-summary__divider"></div>
        <span class="govuk-body case-summary__address">2 Desendans Road, Green Village, BU2 3RH</span>
        <a href="#" class="govuk-link case-summary__toggle" aria-expanded="false" aria-controls="proposal-description">Show proposal description</a>
        <div class="case-summary__description" id="proposal-description">
          <p class="govuk-body">Add a conservatory onto the rear of my first storey to use as a reading room and library.</p>
        </div>
      </div>
    </div>

    <!-- Page Layout -->
    <div class="page-layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <!-- Progress bar -->
        <div class="sidebar-progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="14" aria-label="Review progress">
          <div class="sidebar-progress__label">
            <span class="govuk-body-s govuk-!-margin-bottom-0">Review progress</span>
            <span class="govuk-body-s govuk-!-margin-bottom-0"><strong id="progress-count">0</strong> of <strong>14</strong></span>
          </div>
          <div class="sidebar-progress__bar">
            <div class="sidebar-progress__fill" id="progress-fill"></div>
          </div>
        </div>

        <!-- Task list -->
        <nav class="task-list" aria-label="Pre-application report">
          <h2 class="govuk-heading-s task-list__heading">Pre-application report</h2>
          <ul class="task-list__items">
            <li class="task-list__item task-list__item--not-reviewed" data-section="pre-application-outcome">
              <a href="index.html#pre-application-outcome" class="task-list__link govuk-service-navigation__link">
                <span class="task-list__status" aria-hidden="true"></span>
                <span class="task-list__name">Pre-application outcome</span>
              </a>
            </li>
            <li class="task-list__item task-list__item--not-reviewed" data-section="officer-contact-details">
              <a href="index.html#officer-contact-details" class="task-list__link govuk-service-navigation__link">
                <span class="task-list__status" aria-hidden="true"></span>
                <span class="task-list__name">Officer contact details</span>
              </a>
            </li>
            <li class="task-list__item task-list__item--not-reviewed" data-section="your-pre-application-details">
              <a href="index.html#your-pre-application-details" class="task-list__link govuk-service-navigation__link">
                <span class="task-list__status" aria-hidden="true"></span>
                <span class="task-list__name">Your pre-application details</span>
              </a>
            </li>
            <li class="task-list__item task-list__item--not-reviewed" data-section="description-of-your-proposal">
              <a href="index.html#description-of-your-proposal" class="task-list__link govuk-service-navigation__link">
                <span class="task-list__status" aria-hidden="true"></span>
                <span class="task-list__name">Description of your proposal</span>
              </a>
            </li>
            <li class="task-list__item task-list__item--not-reviewed" data-section="site-map">
              <a href="index.html#site-map" class="task-list__link govuk-service-navigation__link">
                <span class="task-list__status" aria-hidden="true"></span>
                <span class="task-list__name">Site map</span>
              </a>
            </li>
            <li class="task-list__item task-list__item--not-reviewed" data-section="site-constraints">
              <a href="index.html#site-constraints" class="task-list__link govuk-service-navigation__link">
                <span class="task-list__status" aria-hidden="true"></span>
                <span class="task-list__name">Relevant site constraints</span>
              </a>
            </li>
            <li class="task-list__item task-list__item--not-reviewed" data-section="site-history">
              <a href="index.html#site-history" class="task-list__link govuk-service-navigation__link">
                <span class="task-list__status" aria-hidden="true"></span>
                <span class="task-list__name">Relevant site history</span>
              </a>
            </li>
            <li class="task-list__item task-list__item--not-reviewed task-list__item--active" data-section="site-and-surroundings">
              <a href="index.html#site-and-surroundings" class="task-list__link govuk-service-navigation__link" aria-current="page">
                <span class="task-list__status" aria-hidden="true"></span>
                <span class="task-list__name">Site and surroundings</span>
              </a>
            </li>
            <li class="task-list__item task-list__item--not-reviewed" data-section="planning-considerations-and-advice">
              <a href="index.html#planning-considerations-and-advice" class="task-list__link govuk-service-navigation__link">
                <span class="task-list__status" aria-hidden="true"></span>
                <span class="task-list__name">Planning considerations and advice</span>
              </a>
            </li>
            <li class="task-list__item task-list__item--not-reviewed" data-section="summary-of-advice">
              <a href="index.html#summary-of-advice" class="task-list__link govuk-service-navigation__link">
                <span class="task-list__status" aria-hidden="true"></span>
                <span class="task-list__name">Summary of advice</span>
              </a>
            </li>
            <li class="task-list__item task-list__item--not-reviewed" data-section="relevant-policies-and-guidance">
              <a href="index.html#relevant-policies-and-guidance" class="task-list__link govuk-service-navigation__link">
                <span class="task-list__status" aria-hidden="true"></span>
                <span class="task-list__name">Relevant policies and guidance</span>
              </a>
            </li>
            <li class="task-list__item task-list__item--not-reviewed" data-section="requirements">
              <a href="index.html#requirements" class="task-list__link govuk-service-navigation__link">
                <span class="task-list__status" aria-hidden="true"></span>
                <span class="task-list__name">Requirements</span>
              </a>
            </li>
            <li class="task-list__item task-list__item--not-reviewed" data-section="next-steps">
              <a href="index.html#next-steps" class="task-list__link govuk-service-navigation__link">
                <span class="task-list__status" aria-hidden="true"></span>
                <span class="task-list__name">Next steps</span>
              </a>
            </li>
            <li class="task-list__item task-list__item--not-reviewed" data-section="disclaimer">
              <a href="index.html#disclaimer" class="task-list__link govuk-service-navigation__link">
                <span class="task-list__status" aria-hidden="true"></span>
                <span class="task-list__name">Disclaimer</span>
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="main-content" id="main-content" role="main">
        <div class="main-content-wrapper">
          <a href="index.html#site-and-surroundings" class="govuk-back-link">Back to Review</a>
          <h1 class="govuk-heading-xl">Edit site and surroundings</h1>

          <form>
            <div class="govuk-form-group">
              <label class="govuk-label govuk-label--m" for="site-description">
                Description of the site
              </label>
              <div id="site-description-hint" class="govuk-hint">
                You can include:
                <ul class="govuk-list govuk-list--bullet govuk-!-margin-top-2">
                  <li>Describe buildings already on the site</li>
                  <li>Relationships to neighbouring buildings</li>
                  <li>Relevant constraints, such as trees or classified roads</li>
                  <li>Main uses of land in the surrounding area</li>
                </ul>
              </div>
              <textarea class="govuk-textarea" id="site-description" name="site-description" rows="12" aria-describedby="site-description-hint">The application site comprises a two-storey Victorian mid-terrace dwelling constructed of yellow London stock brick with a slate roof and original timber sash windows to the front elevation. The rear garden extends approximately 12 metres and is enclosed by timber fencing to the side boundaries. The property is flanked by similar two-storey Victorian terraced dwellings at Nos. 1 and 3 Desendans Road, with No. 3 having an existing single-storey rear extension. To the rear, the site backs onto the gardens of properties fronting Elmwood Avenue.

The site is located within the Green Village Conservation Area. A mature oak tree subject to a Tree Preservation Order (TPO/2019/0042) stands in the rear garden of No. 3, with its canopy extending partially over the application site. The property also falls within the buffer zone of Southwark Woods Site of Special Scientific Interest (SSSI), located approximately 150 metres to the east.

The surrounding area is predominantly residential in character, comprising Victorian and Edwardian terraced housing. Desendans Road is an unclassified road within a 20mph zone. Local amenities including shops and a primary school are situated on Green Village High Street, approximately 200 metres to the north, and the area benefits from good public transport links with Green Village Station within a 5-minute walk.</textarea>
            </div>

            <div class="app-button-group">
              <button type="button" class="govuk-button" data-module="govuk-button" id="save-button">
                Save and return to review
              </button>
              <a href="index.html#site-and-surroundings" class="govuk-link" id="cancel-link">Cancel</a>
            </div>
          </form>

        </div>
      </main>
    </div>

    <!-- GOV.UK Frontend JS -->
    <script type="module" src="/javascripts/govuk-frontend.min.js"></script>
    <script type="module">
      import { initAll } from '/javascripts/govuk-frontend.min.js'
      initAll()
    </script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/components/js/supabase-client.js"></script>

    <!-- Component JS -->
    <script src="/components/js/case-summary.js"></script>
    <script src="/components/js/status-icons.js"></script>
    <script src="/components/js/sidebar.js"></script>

    <!-- Initialize page -->
    <script>
      document.addEventListener('DOMContentLoaded', async function() {
        var textarea = document.getElementById('site-description');
        var saveButton = document.getElementById('save-button');
        var cancelLink = document.getElementById('cancel-link');
        var backLink = document.querySelector('.govuk-back-link');
        var queryString = window.location.search;
        var urlParams = new URLSearchParams(queryString);
        var reportId = urlParams.get('reportId');

        // Build the return URL with query params and hash
        function getReturnUrl() {
          return 'index.html' + queryString + '#site-and-surroundings';
        }

        // Populate status icons for all sidebar items
        document.querySelectorAll('.task-list__item').forEach(function(item) {
          var statusEl = item.querySelector('.task-list__status');
          if (statusEl && window.StatusIcons) {
            statusEl.innerHTML = window.StatusIcons.get('empty');
          }
        });

        // Load content from Supabase
        if (reportId && window.SupabaseClient) {
          var content = await window.SupabaseClient.loadSiteDescription(reportId);
          if (content) {
            textarea.value = content;
          }
        }

        // Update links with query parameters
        if (queryString) {
          document.querySelectorAll('a[href^="index.html"]').forEach(function(link) {
            var href = link.getAttribute('href');
            var hashIndex = href.indexOf('#');
            if (hashIndex !== -1) {
              link.setAttribute('href', 'index.html' + queryString + href.substring(hashIndex));
            } else {
              link.setAttribute('href', href + queryString);
            }
          });

          if (backLink) {
            backLink.setAttribute('href', getReturnUrl());
          }
        }

        // Save button click handler
        saveButton.addEventListener('click', async function() {
          if (reportId && window.SupabaseClient) {
            // Save to Supabase
            var success = await window.SupabaseClient.updateSiteDescription(reportId, textarea.value);
            if (!success) {
              alert('Error saving changes. Please try again.');
              return;
            }
          }

          // Navigate back to Review page
          window.location.href = getReturnUrl();
        });
      });
    </script>
  </body>
</html>
